# Pip - VPS Integration Configuration
#
# Use this when deploying alongside existing services on do-vps-prod
#
# Usage:
#   1. Copy to VPS: /opt/do-vps-prod/docker/droplet/
#   2. Add entries to Caddyfile (app.pip.arcforge.au + mcp.pip.arcforge.au)
#   3. docker compose -f docker-compose.yml -f docker-compose.pip.yml up -d

services:
  # ===========================================
  # Pip Main Server (PWA + API)
  # Domain: app.pip.arcforge.au
  # ===========================================
  pip-app:
    image: ghcr.io/iamsamuelrodda/pip:latest
    # Or build locally:
    # build:
    #   context: /opt/pip
    #   dockerfile: Dockerfile
    container_name: pip-app
    restart: unless-stopped
    networks:
      - frontend
    volumes:
      - pip-data:/app/data
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_PROVIDER=sqlite
      - DATABASE_PATH=/app/data/pip.db
      - ANTHROPIC_API_KEY=${PIP_ANTHROPIC_KEY}
      - XERO_CLIENT_ID=${PIP_XERO_CLIENT_ID}
      - XERO_CLIENT_SECRET=${PIP_XERO_CLIENT_SECRET}
      - JWT_SECRET=${PIP_JWT_SECRET}
      - BASE_URL=https://${PIP_DOMAIN:-app.pip.arcforge.au}
      - FRONTEND_URL=https://${PIP_DOMAIN:-app.pip.arcforge.au}
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '0.5'
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # Pip MCP Remote Server (Claude.ai/ChatGPT)
  # Domain: mcp.pip.arcforge.au
  # ===========================================
  pip-mcp:
    image: ghcr.io/iamsamuelrodda/pip-mcp:latest
    # Or build locally:
    # build:
    #   context: /opt/pip
    #   dockerfile: packages/mcp-remote-server/Dockerfile
    container_name: pip-mcp
    restart: unless-stopped
    networks:
      - frontend
    volumes:
      # Share SQLite database with main server
      - pip-data:/app/data
    environment:
      - NODE_ENV=production
      - MCP_PORT=3001
      - DATABASE_PATH=/app/data/pip.db
      - XERO_CLIENT_ID=${PIP_XERO_CLIENT_ID}
      - XERO_CLIENT_SECRET=${PIP_XERO_CLIENT_SECRET}
      - JWT_SECRET=${PIP_JWT_SECRET}
      - BASE_URL=https://${PIP_MCP_DOMAIN:-mcp.pip.arcforge.au}
    deploy:
      resources:
        limits:
          memory: 256M  # Lighter than main server (no PWA)
          cpus: '0.25'
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      pip-app:
        condition: service_healthy

volumes:
  pip-data:
    name: pip-data

# Network should already exist from main docker-compose.yml
networks:
  frontend:
    external: true
